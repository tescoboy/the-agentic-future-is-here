{% extends "base.html" %}

{% block title %}Brief Results - AdCP Demo{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Summary Statistics -->
            {% if summary_stats.total > 0 %}
                <div class="alert alert-info results-summary" role="alert">
                    <i class="fa-solid fa-chart-bar me-2"></i>
                    <strong>Summary:</strong> {{ summary_stats.success }} agents succeeded, {{ summary_stats.failure }} failed
                </div>
            {% endif %}

            <!-- Orchestrator Error -->
            {% if orchestrator_error %}
                <div class="alert alert-danger" role="alert">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                    {{ orchestrator_error }}
                </div>
            {% endif %}

            <!-- Submitted Brief -->
            <div class="card mb-4 shadow brief-display">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0">
                        <i class="fa-solid fa-file-lines me-2"></i>
                        Submitted Brief
                    </h3>
                </div>
                <div class="card-body">
                    <p class="mb-0 card-text">{{ brief }}</p>
                </div>
            </div>

            <!-- Sales Results -->
            <div class="card mb-4 shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fa-solid fa-shopping-cart me-2"></i>
                        Sales Results
                    </h3>
                </div>
                <div class="card-body">
                    {% if sales_results %}
                        {% for result in sales_results %}
                            {% if result.ok %}
                                {% if result.product_items %}
                                    <h5 class="mb-3">
                                        {{ result.agent.name }}
                                        {% if result.warnings and result.warnings|length > 0 %}
                                            <span class="badge bg-warning text-dark ms-2">
                                                <i class="fa-solid fa-exclamation-triangle me-1"></i>
                                                {{ result.warnings|length }} warnings
                                            </span>
                                        {% endif %}
                                    </h5>
                                    
                                    <div class="row">
                                        {% for item in result.product_items %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100 shadow-sm product-result-card">
                                                    <div class="card-header d-flex justify-content-between align-items-start bg-light">
                                                        <h6 class="mb-0 fw-bold product-title" title="{{ item.product_name }}">{{ item.product_name }}</h6>
                                                        <button class="btn btn-success btn-sm" onclick="activateCampaign('{{ item.product_name }}')">
                                                            <i class="fa-solid fa-rocket me-1"></i>
                                                            Activate
                                                        </button>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="card-text product-description mb-3">
                                                            {{ item.product_description }}
                                                        </p>
                                                        
                                                        <!-- Product Metadata -->
                                                        <div class="row mb-3">
                                                            <div class="col-6">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <i class="fa-solid fa-dollar-sign text-success me-2"></i>
                                                                    <span class="price-display product-price">${{ "%.2f"|format(item.price_cpm) }} CPM</span>
                                                                </div>
                                                                <div class="d-flex align-items-center">
                                                                    <i class="fa-solid fa-truck text-info me-2"></i>
                                                                    <span class="badge {% if item.is_guaranteed %}bg-success{% else %}bg-warning{% endif %} text-truncate badge-delivery" title="{{ item.delivery_type }}">
                                                                        {{ item.delivery_type }}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            <div class="col-6">
                                                                {% if item.formats %}
                                                                    <div class="mb-2">
                                                                        <small class="text-muted d-block mb-1">
                                                                            <i class="fa-solid fa-tv me-1"></i>
                                                                            <strong>Formats:</strong>
                                                                        </small>
                                                                        <div class="d-flex flex-wrap">
                                                                            {% for format in item.formats %}
                                                                                <span class="badge bg-primary me-1 mb-1 text-truncate badge-format" title="{{ format }}">{{ format }}</span>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                                {% if item.targeting %}
                                                                    <div>
                                                                        <small class="text-muted d-block mb-1">
                                                                            <i class="fa-solid fa-globe me-1"></i>
                                                                            <strong>Geo:</strong>
                                                                        </small>
                                                                        <div class="d-flex flex-wrap">
                                                                            {% if item.targeting.geo_country_any_of %}
                                                                                {% for country in item.targeting.geo_country_any_of %}
                                                                                    {% set country_display = {
                                                                                        'usa': 'USA',
                                                                                        'uk': 'UK',
                                                                                        'australia': 'Australia',
                                                                                        'france': 'France',
                                                                                        'germany': 'Germany',
                                                                                        'singapore': 'Singapore'
                                                                                    }.get(country.lower(), country) %}
                                                                                    <span class="badge bg-secondary me-1 mb-1 text-truncate badge-targeting" title="{{ country_display }}">{{ country_display }}</span>
                                                                                {% endfor %}
                                                                            {% elif item.targeting.geo %}
                                                                                {% for country in item.targeting.geo %}
                                                                                    {% set country_display = {
                                                                                        'usa': 'USA',
                                                                                        'uk': 'UK',
                                                                                        'australia': 'Australia',
                                                                                        'france': 'France',
                                                                                        'germany': 'Germany',
                                                                                        'singapore': 'Singapore'
                                                                                    }.get(country.lower(), country) %}
                                                                                    <span class="badge bg-secondary me-1 mb-1 text-truncate badge-targeting" title="{{ country_display }}">{{ country_display }}</span>
                                                                                {% endfor %}
                                                                            {% else %}
                                                                                {% for key, value in item.targeting.items() %}
                                                                                    {% if key != 'device_type_any_of' and key != 'device_type' %}
                                                                                        {% if value is sequence and value is not string %}
                                                                                            {% for v in value %}
                                                                                                <span class="badge bg-secondary me-1 mb-1 text-truncate badge-targeting" title="{{ v }}">{{ v }}</span>
                                                                                            {% endfor %}
                                                                                        {% else %}
                                                                                            <span class="badge bg-secondary me-1 mb-1 text-truncate badge-targeting" title="{{ value }}">{{ value }}</span>
                                                                                        {% endif %}
                                                                                    {% endif %}
                                                                                {% endfor %}
                                                                            {% endif %}
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        <hr class="my-3">
                                                        
                                                        <!-- Reason Section with Expandable Text -->
                                                        <div class="mb-2">
                                                            <strong>Reason:</strong>
                                                            <div class="reason-text-container" data-full-text="{{ item.reason }}">
                                                                <p class="card-text mb-0 reason-text-preview">
                                                                    {{ item.reason }}
                                                                </p>
                                                                {% if item.reason|length > 200 %}
                                                                    <button class="btn btn-link btn-sm p-0 mt-1 reason-toggle" onclick="toggleReasonText(this)">
                                                                        <i class="fa-solid fa-chevron-down me-1"></i>
                                                                        Show more
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if item.score is not none %}
                                                            <div class="d-flex align-items-center">
                                                                <span class="me-2">
                                                                    {{ generate_heat_indicator(item.score) | safe }}
                                                                </span>
                                                                <small class="text-muted">
                                                                    Match {{ (item.score * 100) | round(0) | int }}%
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light" role="alert">
                                        <i class="fa-solid fa-info-circle me-2"></i>
                                        <strong>{{ result.agent.name }}:</strong> No high-confidence matches (≥70%).
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-danger" role="alert">
                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                    <strong>{{ result.agent.name }}:</strong> {{ result.error }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-light" role="alert">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No sales agents were selected or processed.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Signals Results -->
            <div class="card mb-4 shadow">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">
                        <i class="fa-solid fa-signal me-2"></i>
                        Signals Results
                    </h3>
                </div>
                <div class="card-body">
                    {% if signals %}
                        {% for signal in signals %}
                            {% if signal.ok %}
                                {% if signal.signal_items %}
                                    <h5 class="mb-3">{{ signal.agent.name }}</h5>
                                    
                                    <div class="row">
                                        {% for item in signal.signal_items %}
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6 class="mb-0 fw-bold product-title" title="{{ item.name }}">{{ item.name }}</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <!-- Reason Section with Expandable Text -->
                                                        <div class="mb-2">
                                                            <strong>Reason:</strong>
                                                            <div class="reason-text-container" data-full-text="{{ item.reason }}">
                                                                <p class="card-text mb-0 reason-text-preview">
                                                                    {{ item.reason }}
                                                                </p>
                                                                {% if item.reason|length > 200 %}
                                                                    <button class="btn btn-link btn-sm p-0 mt-1 reason-toggle" onclick="toggleReasonText(this)">
                                                                        <i class="fa-solid fa-chevron-down me-1"></i>
                                                                        Show more
                                                                    </button>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        
                                                        {% if item.score is not none %}
                                                            <div class="d-flex align-items-center">
                                                                <span class="me-2">
                                                                    {{ generate_heat_indicator(item.score) | safe }}
                                                                </span>
                                                                <small class="text-muted">
                                                                    Match {{ (item.score * 100) | round(0) | int }}%
                                                                </small>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-light" role="alert">
                                        <i class="fa-solid fa-info-circle me-2"></i>
                                        <strong>{{ signal.agent.name }}:</strong> No signals found.
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-danger" role="alert">
                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                    <strong>{{ signal.agent.name }}:</strong> {{ signal.error }}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-light" role="alert">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No signals agents were selected or processed.
                        </div>
                    {% endif %}
                </div>
            </div>



            <!-- Navigation -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <a href="/buyer" class="btn btn-primary btn-lg">
                    <i class="fa-solid fa-plus me-2"></i>
                    Submit Another Brief
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function activateCampaign(productName) {
    alert('Campaign activated for: ' + productName);
}

function toggleReasonText(button) {
    const container = button.closest('.reason-text-container');
    const preview = container.querySelector('.reason-text-preview');
    const icon = button.querySelector('i');
    const text = button.textContent.trim();
    
    if (preview.style.maxHeight === 'none') {
        // Collapse
        preview.style.maxHeight = '4.5em';
        icon.className = 'fa-solid fa-chevron-down me-1';
        button.innerHTML = '<i class="fa-solid fa-chevron-down me-1"></i>Show more';
    } else {
        // Expand
        preview.style.maxHeight = 'none';
        icon.className = 'fa-solid fa-chevron-up me-1';
        button.innerHTML = '<i class="fa-solid fa-chevron-up me-1"></i>Show less';
    }
}

// Initialize tooltips for truncated elements
document.addEventListener('DOMContentLoaded', function() {
    // Add tooltips to truncated elements
    const truncatedElements = document.querySelectorAll('.text-truncate');
    truncatedElements.forEach(function(element) {
        if (element.scrollWidth > element.clientWidth) {
            element.setAttribute('data-bs-toggle', 'tooltip');
            element.setAttribute('data-bs-placement', 'top');
        }
    });
    
    // Initialize Bootstrap tooltips
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // ===============================================
    // ADVANCED DEBUG CONSOLE LOGGING SYSTEM
    // ===============================================
    
    const DebugConsole = {
        styles: {
            agent: 'color: #2E8B57; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);',
            section: 'color: #4169E1; font-weight: bold; font-size: 12px; text-decoration: underline;',
            data: 'color: #708090; font-size: 11px; font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;',
            success: 'color: #228B22; font-weight: bold;',
            warning: 'color: #FF8C00; font-weight: bold;',
            error: 'color: #DC143C; font-weight: bold;',
            highlight: 'color: #9932CC; font-weight: bold; background: rgba(153, 50, 204, 0.1); padding: 2px 4px;',
            value: 'color: #2F4F4F; font-weight: normal;'
        },
        
        logAgentDebug: function(agentName, debugData) {
            console.groupCollapsed(
                `%c🤖 ${agentName} - Complete Debug Information`, 
                this.styles.agent
            );
            
            // 1. Query Expansion Analysis
            console.groupCollapsed('%c📝 1. Query Expansion Analysis', this.styles.section);
            if (debugData.queryExpansion) {
                console.log('%cWas Expanded:', this.styles.highlight, debugData.queryExpansion.expanded ? 'YES' : 'NO');
                if (debugData.queryExpansion.expanded) {
                    console.log('%cOriginal Query:', this.styles.data, debugData.queryExpansion.original);
                    console.log('%cExpanded Query:', this.styles.value, debugData.queryExpansion.expandedQuery);
                    console.log('%cExpansion Terms:', this.styles.data, debugData.queryExpansion.terms.join(', '));
                }
            } else {
                console.log('%cNo expansion data available', this.styles.warning);
            }
            console.groupEnd();
            
            // 2. RAG Filter Strategy
            console.groupCollapsed('%c🔍 2. RAG Filter Strategy & Results', this.styles.section);
            if (debugData.ragFilter) {
                console.log('%cStrategy Used:', this.styles.highlight, debugData.ragFilter.strategy);
                console.log('%cTotal Candidates Found:', this.styles.highlight, debugData.ragFilter.totalCandidates);
                console.log('%cTop Results with Scores:', this.styles.data);
                console.table(debugData.ragFilter.topResults.map((result, idx) => ({
                    Rank: idx + 1,
                    'Product Name': result.name,
                    'RAG Score': result.rag_score,
                    'FTS Score': result.fts_score,
                    'Combined': result.combined_score
                })));
            } else {
                console.log('%cNo RAG filter data available', this.styles.warning);
            }
            console.groupEnd();
            
            // 3. Web Grounding Snippets
            console.groupCollapsed('%c🌐 3. Web Grounding Snippets', this.styles.section);
            if (debugData.webGrounding && debugData.webGrounding.snippets && debugData.webGrounding.snippets.length > 0) {
                console.log('%cTotal Snippets Generated:', this.styles.highlight, debugData.webGrounding.snippets.length);
                console.log('%cWeb Search Results Table:', this.styles.data);
                console.table(debugData.webGrounding.snippets.map((snippet, idx) => ({
                    '#': idx + 1,
                    'Related Product': snippet.product,
                    'Content Preview': snippet.content.length > 80 ? 
                        snippet.content.substring(0, 80) + '...' : snippet.content,
                    'Full Length': snippet.content.length + ' chars'
                })));
                
                console.log('%cFull Snippet Details:', this.styles.data);
                debugData.webGrounding.snippets.forEach((snippet, idx) => {
                    console.groupCollapsed(`%c📄 Snippet ${idx + 1}: ${snippet.product}`, this.styles.data);
                    console.log(`%c"${snippet.content}"`, this.styles.value);
                    console.groupEnd();
                });
            } else {
                console.log('%cNo web grounding snippets available', this.styles.warning);
            }
            console.groupEnd();
            
            // 4. Sales Agent Prompt
            console.groupCollapsed('%c📋 4. Sales Agent Prompt Details', this.styles.section);
            if (debugData.salesPrompt) {
                console.log('%cPrompt Source:', this.styles.highlight, debugData.salesPrompt.source.toUpperCase());
                console.log('%cFull Prompt Used:', this.styles.data);
                console.log('%c' + debugData.salesPrompt.fullPrompt, this.styles.value);
            } else {
                console.log('%cNo sales prompt data available', this.styles.warning);
            }
            console.groupEnd();
            
            // 5. Final Results Summary
            console.groupCollapsed('%c📊 5. Results Summary', this.styles.section);
            console.log('%cAgent Success:', this.styles.highlight, debugData.results.success ? '✅ SUCCESS' : '❌ FAILED');
            console.log('%cTotal Products Returned:', this.styles.data, debugData.results.totalItems);
            console.log('%cProcessing Time:', this.styles.data, debugData.results.processingTime || 'Not measured');
            if (debugData.results.errorMessage) {
                console.log('%cError:', this.styles.error, debugData.results.errorMessage);
            }
            console.groupEnd();
            
            console.groupEnd();
        },
        
        extractDebugData: function() {
            const salesResults = {{ sales_results | tojson }};
            const ragLogs = {{ rag_debug_logs | tojson }};
            
            console.log('%c🚀 Advanced Debug Console System Activated', 
                       'color: #FF6347; font-weight: bold; font-size: 16px; ' +
                       'background: linear-gradient(90deg, #FF6347, #FFA500); ' +
                       'padding: 8px 16px; border-radius: 4px; color: white;');
            
            console.log('🐛 DEBUG: ragLogs array:', ragLogs);
            console.log('🐛 DEBUG: salesResults array:', salesResults);
            
            console.log('%c📊 Processing debug data for ' + salesResults.length + ' agent(s)...', 
                       'color: #4682B4; font-size: 12px; margin-top: 10px;');
            
            // Process each agent's results
            salesResults.forEach((result, idx) => {
                const agentName = result.agent?.name || `Agent ${idx + 1}`;
                
                const debugData = {
                    queryExpansion: this.parseQueryExpansion(ragLogs),
                    ragFilter: this.parseRAGFilter(ragLogs),
                    webGrounding: this.parseWebGrounding(result, ragLogs),
                    salesPrompt: this.parseSalesPrompt(result),
                    results: {
                        success: result.ok,
                        totalItems: result.product_items?.length || 0,
                        processingTime: result.processing_time,
                        errorMessage: result.error
                    }
                };
                
                this.logAgentDebug(agentName, debugData);
            });
            
            console.log('%c✨ Debug analysis complete! Check the collapsed groups above for detailed information.', 
                       'color: #228B22; font-weight: bold; font-size: 12px; margin-top: 10px;');
        },
        
        parseQueryExpansion: function(ragLogs) {
            const expansionCompleteLog = ragLogs.find(log => log.includes('Expansion complete:'));
            const expandedQueryLog = ragLogs.find(log => log.includes('Expanded Query:'));
            const expansionTermsLog = ragLogs.find(log => log.includes('Expansion Terms:'));
            const originalQueryLog = ragLogs.find(log => log.includes('QUERY EXPANSION:'));
            
            if (expansionCompleteLog) {
                // Extract terms from "Expansion complete: ['term1', 'term2', ...]"
                const termsMatch = expansionCompleteLog.match(/\[(.*?)\]/);
                const terms = termsMatch ? termsMatch[1].split("', '").map(t => t.replace(/'/g, '')) : [];
                
                // Extract expanded query
                const expandedQuery = expandedQueryLog ? 
                    expandedQueryLog.split('Expanded Query: ')[1]?.replace(/'/g, '') : 
                    terms.join(' ');
                
                // Extract original query
                const original = originalQueryLog ? 
                    originalQueryLog.split('QUERY EXPANSION: ')[1]?.replace(/'/g, '') :
                    'Original brief text';
                
                return {
                    expanded: true,
                    original: original,
                    expandedQuery: expandedQuery,
                    terms: terms
                };
            }
            
            return { expanded: false, original: 'No expansion performed' };
        },
        
        parseRAGFilter: function(ragLogs) {
            const strategyLog = ragLogs.find(log => log.includes('Strategy Used:'));
            const candidatesLog = ragLogs.find(log => log.includes('Total Candidates:'));
            const topResultsLogs = ragLogs.filter(log => 
                log.includes('ID:') && log.includes('|') && log.includes('RAG:') && log.includes('FTS:')
            );
            
            if (strategyLog) {
                const strategy = strategyLog.split('Strategy Used: ')[1]?.trim() || 'Unknown';
                const totalCandidates = candidatesLog ? 
                    parseInt(candidatesLog.split('Total Candidates: ')[1]?.match(/\d+/)?.[0]) || 0 : 0;
                
                const topResults = topResultsLogs.slice(0, 5).map((log, idx) => {
                    // Parse format: "   1. ID:   5 | High Income Audience Pack | RAG:0.000 | FTS:1.000 | Combined:0.300 | text_match"
                    const parts = log.split('|').map(p => p.trim());
                    
                    let name = 'Unknown Product';
                    let ragScore = '0.000';
                    let ftsScore = '0.000';
                    let combinedScore = '0.000';
                    
                    if (parts.length >= 4) {
                        name = parts[1] || `Product ${idx + 1}`;
                        ragScore = parts[2]?.split(':')[1]?.trim() || '0.000';
                        ftsScore = parts[3]?.split(':')[1]?.trim() || '0.000';
                        if (parts[4]) {
                            combinedScore = parts[4].split(':')[1]?.trim() || '0.000';
                        }
                    }
                    
                    return { 
                        name, 
                        rag_score: ragScore, 
                        fts_score: ftsScore,
                        combined_score: combinedScore
                    };
                });
                
                return { strategy, totalCandidates, topResults };
            }
            
            return null;
        },
        
        parseWebGrounding: function(result, ragLogs) {
            console.log('🔍 parseWebGrounding called with', ragLogs.length, 'logs');
            
            // Look for actual web grounding snippets in logs
            const snippetLogs = ragLogs.filter(log => 
                log.includes('snippet:') && !log.includes('WEB_DEBUG')
            );
            
            const webDebugLogs = ragLogs.filter(log => 
                log.includes('WEB_DEBUG') && log.includes('snippet:')
            );
            
            console.log('📄 Found', snippetLogs.length, 'snippet logs and', webDebugLogs.length, 'WEB_DEBUG logs');
            
            const processedSnippetLogs = ragLogs.filter(log => 
                log.includes('Raw response text:') ||
                log.includes('Successfully parsed') ||
                log.includes('Product') && log.includes('snippet:')
            );
            
            let snippets = [];
            
            // Extract from direct snippet logs
            snippetLogs.forEach(log => {
                const snippetContent = log.split('snippet:')[1]?.trim();
                if (snippetContent) {
                    snippets.push({
                        content: snippetContent,
                        product: 'From snippet log'
                    });
                }
            });
            
            // Extract from WEB_DEBUG logs with product context
            webDebugLogs.forEach(log => {
                const productMatch = log.match(/Product (.+?) snippet:/);
                const snippetContent = log.split('snippet:')[1]?.trim();
                
                if (snippetContent && productMatch) {
                    snippets.push({
                        content: snippetContent,
                        product: productMatch[1]
                    });
                }
            });
            
            // If we still don't have snippets, look for raw JSON responses
            const jsonResponseLogs = ragLogs.filter(log => 
                log.includes('Raw response text:') && log.includes('snippets')
            );
            
            jsonResponseLogs.forEach(log => {
                try {
                    // Look for JSON pattern in the log and extract snippets array
                    const jsonStart = log.indexOf('{"snippets"');
                    if (jsonStart !== -1) {
                        // Find the end of the JSON by looking for the closing bracket
                        let jsonEnd = jsonStart;
                        let bracketCount = 0;
                        for (let i = jsonStart; i < log.length; i++) {
                            if (log[i] === '{') bracketCount++;
                            if (log[i] === '}') bracketCount--;
                            if (bracketCount === 0) {
                                jsonEnd = i + 1;
                                break;
                            }
                        }
                        
                        const jsonStr = log.substring(jsonStart, jsonEnd);
                        const responseData = JSON.parse(jsonStr);
                        
                        if (responseData.snippets && Array.isArray(responseData.snippets)) {
                            responseData.snippets.forEach((snippet, idx) => {
                                if (typeof snippet === 'string' && snippet.length > 10) {
                                    snippets.push({
                                        content: snippet,
                                        product: 'From JSON response ' + (idx + 1)
                                    });
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.warn('Failed to parse JSON from log:', e);
                }
            });
            
            // Remove duplicates
            const uniqueSnippets = snippets.filter((snippet, index, self) => 
                index === self.findIndex(s => s.content === snippet.content)
            );
            
            if (uniqueSnippets.length > 0) {
                return { snippets: uniqueSnippets };
            }
            
            return null;
        },
        
        parseSalesPrompt: function(result) {
            // Get the default sales prompt from the system
            const defaultPrompt = 'You are an expert media seller working for {tenant_name}. Your job is to find relevant products for a programmatic advertising campaign. Campaign Brief: {brief}. Available Products: {products}. Helpful live web search results that relate to available products (may not always be provided): {web_grounding_results}. Your task: 1. Analyze each product relevance to the campaign brief. Use the product title and description and be sure to use the helpful live web search results that relates to that product. 2. Rank products from most to least relevant. 3. Return the top products. Response format (JSON only): {"products": [{"product_id": "product_id_here", "relevance_score": 0.95, "reasoning": "Why this product is relevant..."}]}. Focus on: - Targeting alignment with brief requirements - be sure to use the helpful live web search results that relates to that product. VOICE: Always be positive. Return ONLY the JSON response, no additional text.';

            return {
                source: result.prompt_source || 'default',
                fullPrompt: result.custom_prompt || defaultPrompt
            };
        },
        
        extractValue: function(logs, key) {
            const log = logs.find(l => l.includes(key));
            return log ? log.split(key)[1]?.trim() : null;
        }
    };
    
    // Initialize the debug system
    DebugConsole.extractDebugData();
    
});

</script>
{% endblock %}
